<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Walking Duck Weather Widget</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- THEMES & VARIABLES --- */
        :root {
            --card-bg-light: rgba(255, 255, 255, 0.2);
            --card-bg-dark: rgba(0, 0, 0, 0.2);
            --bg-color-light: #87CEEB;
            --text-color-light: #2c3e50;
            --bg-color-dark: #2c3e50;
            --text-color-dark: #ecf0f1;
        }

        /* --- GENERAL SETUP --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            transition: background-color 1s ease, color 1s ease;
        }
        body.light-theme { background-color: var(--bg-color-light); color: var(--text-color-light); }
        body.dark-theme { background-color: var(--bg-color-dark); color: var(--text-color-dark); }

        /* --- CHARACTER SCENE & ANIMATIONS --- */
        #character-scene {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            overflow-x: hidden;
        }

        /* Duck Wrapper for forward movement */
        .duck-wrapper {
            position: absolute;
            top: 60%;
            left: 0;
            transform: translateY(-50%);
            animation: move-forward 15s linear infinite;
        }
        
        /* Stop walking animation when needed */
        .duck-wrapper.is-stationary {
            animation: none;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        @keyframes move-forward {
            from { transform: translateX(-350px) translateY(-50%); }
            to { transform: translateX(100vw) translateY(-50%); }
        }

        /* Duck Container for waddle */
        .duck-container {
            position: relative;
            width: 350px;
            height: 350px;
            animation: waddle 0.8s ease-in-out infinite;
        }
        
        .duck-wrapper.is-stationary .duck-container {
            animation: bob 2s ease-in-out infinite; /* A gentle bob when stationary */
        }

        @keyframes waddle {
            0%, 100% { transform: translateY(0) rotate(0); }
            50% { transform: translateY(-10px) rotate(2deg); }
        }
        
        @keyframes bob {
             0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .duck-body {
            position: absolute;
            bottom: 100px;
            left: 50px;
            width: 200px;
            height: 150px;
            background-color: #1c1c1c;
            border-radius: 0 0 100px 100px;
            z-index: 2;
        }
        
        .duck-wing {
            position: absolute;
            top: 60px;
            left: 50px;
            width: 100px;
            height: 60px;
            background-color: #111;
            border-radius: 50%;
            transform-origin: top left;
            animation: flap-wing 0.8s ease-in-out infinite;
        }
        @keyframes flap-wing {
            0%, 100% { transform: rotate(0); }
            50% { transform: rotate(-8deg); }
        }

        .duck-head {
            position: absolute;
            top: 20px;
            left: 170px;
            width: 110px;
            height: 110px;
            background-color: #1c1c1c;
            border-radius: 50%;
            z-index: 3;
        }
        
        .duck-eye {
            position: absolute;
            top: 25px;
            left: 25px;
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            overflow: hidden;
        }
        .duck-eye::after { /* Eyelid for blinking */
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1c1c1c;
            transform: translateY(-100%);
            animation: blink 4s infinite;
        }
        @keyframes blink {
            0%, 95%, 100% { transform: translateY(-100%); }
            97% { transform: translateY(0); }
        }
        
        .duck-beak {
            position: absolute;
            top: 45px;
            left: 90px;
            width: 50px;
            height: 25px;
            background-color: #f37a3d;
            border-radius: 10px;
            transform-origin: left center;
            animation: quack 0.8s infinite;
        }
        @keyframes quack {
            0%, 50%, 100% { transform: scaleY(1); }
            25% { transform: scaleY(1.2); }
        }
        
        .duck-leg {
            position: absolute;
            bottom: 70px;
            width: 20px;
            height: 40px;
            background-color: #f37a3d;
            z-index: 1;
            transform-origin: top center;
        }
        
        .leg-left {
            left: 120px;
            animation: move-leg-left 0.8s linear infinite;
        }
        
        .leg-right {
            left: 170px;
            animation: move-leg-right 0.8s linear infinite;
        }

        .duck-foot {
            position: absolute;
            bottom: 65px;
            width: 40px;
            height: 15px;
            background-color: #f37a3d;
            border-radius: 5px;
            z-index: 1;
            transform-origin: top center;
        }
        
        .foot-left {
            left: 110px;
            animation: move-leg-left 0.8s linear infinite;
        }
        
        .foot-right {
           left: 160px;
           animation: move-leg-right 0.8s linear infinite;
        }

        .shadow {
            position: absolute;
            bottom: 55px;
            left: 90px;
            width: 140px;
            height: 25px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 50%;
            z-index: 0;
            animation: waddle-shadow 0.8s ease-in-out infinite;
        }
        @keyframes waddle-shadow {
            0%, 100% { transform: scaleX(1.05); }
            50% { transform: scaleX(1); }
        }

        @keyframes move-leg-left {
            0% { transform: translate(-15px, 0); }
            25% { transform: translate(0px, -10px); }
            50% { transform: translate(15px, 0); }
            75% { transform: translate(0px, 0); }
            100% { transform: translate(-15px, 0); }
        }

        @keyframes move-leg-right {
            0% { transform: translate(15px, 0); }
            25% { transform: translate(0px, 0); }
            50% { transform: translate(-15px, 0); }
            75% { transform: translate(0px, -10px); }
            100% { transform: translate(15px, 0); }
        }

        /* Accessories */
        .accessories {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 4;
            pointer-events: none;
        }
        .sunglasses, .scarf, .umbrella {
            display: none; /* Hidden by default */
            position: absolute;
        }
        .sunglasses {
            top: 40px;
            left: 185px;
            width: 60px;
            height: 20px;
            background: #222;
            border-radius: 10px;
        }
        .scarf {
            top: 110px;
            left: 160px;
            width: 100px;
            height: 25px;
            background: #c0392b;
            border-radius: 10px;
        }
        .umbrella {
            bottom: 150px;
            left: 100px;
            width: 200px;
            height: 100px;
            background: #2980b9;
            border-radius: 100px 100px 0 0;
        }
        .umbrella::after { /* Handle */
            content: '';
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 10px;
            height: 80px;
            background: #7f8c8d;
        }


        /* Environmental Effects */
        .sun-moon { position: absolute; top: 10%; left: 15%; width: 100px; height: 100px; border-radius: 50%; transition: background-color 1s ease, box-shadow 1s ease; animation: pulse 4s infinite; }
        .light-theme .sun-moon { background: #f1c40f; box-shadow: 0 0 50px #f1c40f; }
        .dark-theme .sun-moon { background: #ecf0f1; box-shadow: 0 0 50px #ecf0f1; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        .raindrop, .snowflake, .leaf { position: absolute; animation-iteration-count: infinite; animation-timing-function: linear; }
        .raindrop { bottom: 100%; width: 2px; height: 80px; background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0.4)); animation-name: fall; }
        @keyframes fall { to { transform: translateY(120vh); } }
        .snowflake { top: -20px; width: 10px; height: 10px; background: white; border-radius: 50%; animation-name: snowfall; }
        @keyframes snowfall { to { transform: translateY(110vh) rotate(360deg); opacity: 0; } }
        .leaf { top: -20px; width: 20px; height: 15px; background: #27ae60; border-radius: 5px 50%; animation-name: blow; }
        @keyframes blow { to { transform: translateY(110vh) translateX(50vw) rotate(720deg); opacity: 0; } }

        /* --- UI STYLES --- */
        .main-container { z-index: 1; padding: 20px; width: 100%; max-width: 800px; }
        .weather-card { backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); border-radius: 20px; padding: 30px; transition: background-color 1s ease, border 1s ease; }
        body.light-theme .weather-card { background-color: var(--card-bg-light); border: 1px solid var(--card-border-light); }
        body.dark-theme .weather-card { background-color: var(--card-bg-dark); border: 1px solid var(--card-border-dark); }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;}
        #city-input { padding: 10px 15px; border-radius: 20px; border: none; background: rgba(0,0,0,0.2); color: white; flex-grow: 1; transition: background 0.3s ease; }
        #city-input:focus { background: rgba(0,0,0,0.4); outline: none; }
        .unit-toggle { display: flex; background: rgba(0,0,0,0.2); border-radius: 20px; }
        .unit-toggle button { background: transparent; border: none; color: white; padding: 10px 15px; cursor: pointer; border-radius: 20px; transition: background-color 0.3s ease; }
        .unit-toggle button.active { background-color: rgba(255,255,255,0.3); }
        .current-weather { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .temp-details { text-align: left; }
        #city-name { font-size: 2.5em; font-weight: 700; }
        #weather-description { text-transform: capitalize; }
        #temperature { font-size: 5em; font-weight: 700; }
        #feels-like { margin-top: -10px; }
        #weather-icon { width: 120px; height: 120px; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.3)); }
        .additional-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 20px; border-top: 1px solid; padding-top: 20px; margin-bottom: 30px; border-color: inherit; }
        .detail-item { text-align: center; }
        .detail-item span { font-size: 0.9em; opacity: 0.8; }
        .detail-item strong { font-size: 1.2em; display: block; }
        .forecast-container { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 15px; }
        .forecast-card { flex: 0 0 100px; padding: 15px; border-radius: 15px; text-align: center; transition: transform 0.3s ease, background-color 0.3s ease; }
        .forecast-card:hover { transform: translateY(-10px); background-color: rgba(255,255,255,0.1); }
        .forecast-card img { width: 50px; height: 50px; }
        .forecast-card strong { font-size: 1.2em; }
        .forecast-container::-webkit-scrollbar { height: 8px; }
        .forecast-container::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 10px; }
        .forecast-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 10px; }
    </style>
</head>
<body>
    <div id="character-scene">
        <div class="sun-moon"></div>
        <div class="duck-wrapper">
            <div class="duck-container">
                <div class="accessories">
                    <div class="sunglasses"></div>
                    <div class="scarf"></div>
                    <div class="umbrella"></div>
                </div>
                <div class="duck-head">
                    <div class="duck-eye"></div>
                    <div class="duck-beak"></div>
                </div>
                <div class="duck-body">
                    <div class="duck-wing"></div>
                </div>
                <div class="duck-leg leg-left"></div>
                <div class="duck-foot foot-left"></div>
                <div class="duck-leg leg-right"></div>
                <div class="duck-foot foot-right"></div>
                <div class="shadow"></div>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="weather-card">
             <div class="top-bar">
                <input type="text" id="city-input" placeholder="Search for a city...">
                <div class="unit-toggle">
                    <button id="celsius-btn" class="active">&deg;C</button>
                    <button id="fahrenheit-btn">&deg;F</button>
                </div>
            </div>
            <div class="current-weather">
                <div class="temp-details">
                    <h1 id="city-name">Loading...</h1>
                    <p id="weather-description">Please allow location access</p>
                    <span id="temperature">--&deg;</span>
                    <p id="feels-like">Feels like: --&deg;</p>
                </div>
                <img id="weather-icon" src="" alt="">
            </div>
            <div class="additional-details">
                <div class="detail-item"><span>Humidity</span><strong id="humidity">--%</strong></div>
                <div class="detail-item"><span>Wind Speed</span><strong id="wind-speed">-- km/h</strong></div>
                <div class="detail-item"><span>Sunrise</span><strong id="sunrise">--:--</strong></div>
                <div class="detail-item"><span>Sunset</span><strong id="sunset">--:--</strong></div>
            </div>
            <div class="forecast-container" id="forecast-container"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENTS ---
            const scene = document.getElementById('character-scene');
            const duckWrapper = document.querySelector('.duck-wrapper');
            const sunglasses = document.querySelector('.sunglasses');
            const scarf = document.querySelector('.scarf');
            const umbrella = document.querySelector('.umbrella');
            const cityInput = document.getElementById('city-input');
            const celsiusBtn = document.getElementById('celsius-btn');
            const fahrenheitBtn = document.getElementById('fahrenheit-btn');
            const elements = {
                city: document.getElementById('city-name'),
                desc: document.getElementById('weather-description'),
                temp: document.getElementById('temperature'),
                feels: document.getElementById('feels-like'),
                icon: document.getElementById('weather-icon'),
                humidity: document.getElementById('humidity'),
                wind: document.getElementById('wind-speed'),
                sunrise: document.getElementById('sunrise'),
                sunset: document.getElementById('sunset'),
                forecast: document.getElementById('forecast-container')
            };

            // --- STATE MANAGEMENT ---
            let currentUnit = 'metric';
            let lastQuery = null;

            // --- CHARACTER & SCENE ANIMATION LOGIC ---
            const updateCharacterScene = (weather) => {
                const { main: condition, description } = weather.weather[0];
                const { temp } = weather.main;
                const { speed: windSpeed } = weather.wind;

                // Reset everything first
                sunglasses.style.display = 'none';
                scarf.style.display = 'none';
                umbrella.style.display = 'none';
                duckWrapper.classList.remove('is-stationary');
                document.querySelectorAll('.raindrop, .snowflake, .leaf').forEach(el => el.remove());

                // Weather-based animation
                if (['Rain', 'Drizzle', 'Thunderstorm'].includes(condition)) {
                    duckWrapper.classList.add('is-stationary');
                    umbrella.style.display = 'block';
                    for (let i = 0; i < 50; i++) {
                        const drop = document.createElement('div');
                        drop.className = 'raindrop';
                        drop.style.left = `${Math.random() * 100}vw`;
                        drop.style.animationDelay = `${Math.random() * 2}s`;
                        drop.style.animationDuration = `${0.5 + Math.random() * 0.5}s`;
                        scene.appendChild(drop);
                    }
                } else if (condition === 'Snow' || temp < 10) {
                    duckWrapper.classList.add('is-stationary');
                    scarf.style.display = 'block';
                     if(condition === 'Snow') {
                        for (let i = 0; i < 50; i++) {
                            const flake = document.createElement('div');
                            flake.className = 'snowflake';
                            flake.style.left = `${Math.random() * 100}vw`;
                            flake.style.animationDelay = `${Math.random() * 10}s`;
                            flake.style.animationDuration = `${5 + Math.random() * 5}s`;
                            flake.style.opacity = Math.random();
                            scene.appendChild(flake);
                        }
                    }
                } else if (condition === 'Clear') {
                    duckWrapper.classList.add('is-stationary');
                    sunglasses.style.display = 'block';
                }

                // Add windy effect on top of other conditions
                if (windSpeed > 5) { // Threshold for "windy"
                     for (let i = 0; i < 20; i++) {
                        const leaf = document.createElement('div');
                        leaf.className = 'leaf';
                        leaf.style.left = `${Math.random() * 100}vw`;
                        leaf.style.animationDelay = `${Math.random() * 5}s`;
                        leaf.style.animationDuration = `${5 + Math.random() * 5}s`;
                        scene.appendChild(leaf);
                    }
                }
            };

            // --- UI UPDATE LOGIC ---
            const updateUI = (weather, forecast) => {
                const { name, main, weather: [currentWeather], wind, sys, dt } = weather;
                const isDay = dt > sys.sunrise && dt < sys.sunset;
                document.body.className = isDay ? 'light-theme' : 'dark-theme';
                
                updateCharacterScene(weather);

                const tempUnit = currentUnit === 'metric' ? '°C' : '°F';
                const windUnit = currentUnit === 'metric' ? ' km/h' : ' mph';
                elements.city.textContent = name;
                elements.desc.textContent = currentWeather.description;
                elements.temp.textContent = `${Math.round(main.temp)}${tempUnit}`;
                elements.feels.textContent = `Feels like: ${Math.round(main.feels_like)}${tempUnit}`;
                elements.humidity.textContent = `${main.humidity}%`;
                elements.wind.textContent = `${Math.round(wind.speed)}${windUnit}`;
                elements.icon.src = `https://openweathermap.org/img/wn/${currentWeather.icon}@4x.png`;
                const formatTime = (timestamp) => new Date(timestamp * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                elements.sunrise.textContent = formatTime(sys.sunrise);
                elements.sunset.textContent = formatTime(sys.sunset);
                elements.forecast.innerHTML = '';
                const forecastDays = forecast.list.filter(item => item.dt_txt.includes("12:00:00"));
                forecastDays.forEach(day => {
                    const dayName = new Date(day.dt * 1000).toLocaleDateString('en-US', { weekday: 'short' });
                    elements.forecast.innerHTML += `
                        <div class="forecast-card">
                            <span>${dayName}</span>
                            <img src="https://openweathermap.org/img/wn/${day.weather[0].icon}.png" alt="">
                            <strong>${Math.round(day.main.temp)}${tempUnit}</strong>
                        </div>`;
                });
            };

            // --- FETCH LOGIC ---
            const fetchAndDisplayWeather = async () => {
                if (!lastQuery) return;
                let apiEndpoint;
                if (lastQuery.type === 'city') {
                    apiEndpoint = `/api/getWeather?city=${lastQuery.value}&units=${currentUnit}`;
                } else {
                    apiEndpoint = `/api/getWeather?lat=${lastQuery.value.lat}&lon=${lastQuery.value.lon}&units=${currentUnit}`;
                }
                try {
                    elements.city.textContent = "Fetching...";
                    const response = await fetch(apiEndpoint);
                    if (!response.ok) throw new Error((await response.json()).error);
                    const { weather, forecast } = await response.json();
                    if (lastQuery.type === 'coords') {
                        lastQuery = { type: 'city', value: weather.name };
                    }
                    updateUI(weather, forecast);
                } catch (error) {
                    elements.city.textContent = "Error";
                    elements.desc.textContent = error.message;
                }
            };

            // --- EVENT LISTENERS & INITIALIZATION ---
            cityInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && cityInput.value) {
                    lastQuery = { type: 'city', value: cityInput.value };
                    fetchAndDisplayWeather();
                }
            });
            celsiusBtn.addEventListener('click', () => {
                if (currentUnit !== 'metric') {
                    currentUnit = 'metric';
                    celsiusBtn.classList.add('active');
                    fahrenheitBtn.classList.remove('active');
                    if (lastQuery) fetchAndDisplayWeather();
                }
            });
            fahrenheitBtn.addEventListener('click', () => {
                if (currentUnit !== 'imperial') {
                    currentUnit = 'imperial';
                    fahrenheitBtn.classList.add('active');
                    celsiusBtn.classList.remove('active');
                    if (lastQuery) fetchAndDisplayWeather();
                }
            });
            const init = () => {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        lastQuery = { type: 'coords', value: { lat: position.coords.latitude, lon: position.coords.longitude } };
                        fetchAndDisplayWeather();
                    },
                    () => {
                        lastQuery = { type: 'city', value: 'London' };
                        fetchAndDisplayWeather();
                    }
                );
            };
            init();
        });
    </script>
</body>
</html>
