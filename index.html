<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hyper-Animated Weather Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- THEMES & VARIABLES --- */
        :root {
            --card-bg-light: rgba(255, 255, 255, 0.15);
            --card-bg-dark: rgba(0, 0, 0, 0.15);
            --bg-color-light: #87CEEB;
            --text-color-light: #000000;
            --card-border-light: rgba(255, 255, 255, 0.4);
            --shadow-light: rgba(0, 0, 0, 0.1);
            --bg-color-dark: #0f1a2d;
            --text-color-dark: #ffffff;
            --card-border-dark: rgba(255, 255, 255, 0.2);
            --shadow-dark: rgba(0, 0, 0, 0.3);
        }
        /* All other CSS styles remain the same */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden; transition: background-color 1s ease, color 1s ease; }
        body.light-theme { background-color: var(--bg-color-light); color: var(--text-color-light); }
        body.dark-theme { background-color: var(--bg-color-dark); color: var(--text-color-dark); }
        #weather-scene { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; pointer-events: none; }
        .sun { position: absolute; top: 10%; left: 10%; width: 150px; height: 150px; background: #FFD700; border-radius: 50%; box-shadow: 0 0 50px #FFD700, 0 0 100px #FFD700; animation: pulse 4s infinite ease-in-out; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .mote { position: absolute; width: 3px; height: 3px; background: rgba(255,255,255,0.5); border-radius: 50%; animation: float 20s infinite linear; }
        @keyframes float { from { transform: translateY(100vh) scale(1); } to { transform: translateY(-10vh) scale(0); } }
        .cloud { position: absolute; background: white; border-radius: 50%; opacity: 0.4; animation: drift linear infinite; }
        .cloud.layer1 { animation-duration: 50s; }
        .cloud.layer2 { animation-duration: 75s; }
        .cloud.layer3 { animation-duration: 100s; }
        @keyframes drift { from { transform: translateX(-200px); } to { transform: translateX(110vw); } }
        .raindrop { position: absolute; bottom: 100%; width: 2px; height: 80px; background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0.4)); animation: fall 1s linear infinite; }
        @keyframes fall { to { transform: translateY(120vh); } }
        .snowflake { position: absolute; top: -20px; width: 10px; height: 10px; background: white; border-radius: 50%; opacity: 0.8; animation: snowfall 10s linear infinite; }
        @keyframes snowfall { 0% { transform: translateY(0) translateX(0) rotate(0deg); } 100% { transform: translateY(110vh) translateX(10vw) rotate(360deg); opacity: 0; } }
        .lightning { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.3); z-index: 2; animation: flash 4s infinite; opacity: 0; }
        @keyframes flash { 0%, 95%, 100% { opacity: 0; } 96%, 98% { opacity: 1; } 97%, 99% { opacity: 0; } }
        .main-container { z-index: 1; padding: 20px; width: 100%; max-width: 800px; animation: fadeIn 1.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .weather-card { backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); border-radius: 20px; padding: 30px; transition: background-color 1s ease, border 1s ease, box-shadow 0.3s ease; }
        body.light-theme .weather-card { background-color: var(--card-bg-light); border: 1px solid var(--card-border-light); box-shadow: 0 8px 32px 0 var(--shadow-light); }
        body.dark-theme .weather-card { background-color: var(--card-bg-dark); border: 1px solid var(--card-border-dark); box-shadow: 0 8px 32px 0 var(--shadow-dark); }
        .weather-card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px 0 var(--shadow-dark); }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;}
        #city-input { padding: 10px 15px; border-radius: 20px; border: none; background: rgba(0,0,0,0.2); color: white; flex-grow: 1; transition: background 0.3s ease; }
        #city-input:focus { background: rgba(0,0,0,0.4); outline: none; }
        .unit-toggle { display: flex; background: rgba(0,0,0,0.2); border-radius: 20px; }
        .unit-toggle button { background: transparent; border: none; color: white; padding: 10px 15px; cursor: pointer; border-radius: 20px; transition: background-color 0.3s ease; }
        .unit-toggle button.active { background-color: rgba(255,255,255,0.3); }
        .current-weather { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .temp-details { text-align: left; }
        #city-name { font-size: 2.5em; font-weight: 700; }
        #weather-description { text-transform: capitalize; }
        #temperature { font-size: 5em; font-weight: 700; }
        #feels-like { margin-top: -10px; }
        #weather-icon { width: 120px; height: 120px; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.3)); animation: popIn 1s ease; }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
        .additional-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 20px; border-top: 1px solid; padding-top: 20px; margin-bottom: 30px; border-color: inherit; }
        .detail-item { text-align: center; }
        .detail-item span { font-size: 0.9em; opacity: 0.8; }
        .detail-item strong { font-size: 1.2em; display: block; }
        .forecast-container { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 15px; }
        .forecast-card { flex: 0 0 100px; padding: 15px; border-radius: 15px; text-align: center; transition: transform 0.3s ease, background-color 0.3s ease; }
        .forecast-card:hover { transform: translateY(-10px); background-color: rgba(255,255,255,0.1); }
        .forecast-card img { width: 50px; height: 50px; }
        .forecast-card strong { font-size: 1.2em; }
        .forecast-container::-webkit-scrollbar { height: 8px; }
        .forecast-container::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 10px; }
        .forecast-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 10px; }
    </style>
</head>
<body>
    <div id="weather-scene"></div>
    <div class="main-container">
        <div class="weather-card">
            <div class="top-bar">
                <input type="text" id="city-input" placeholder="Search for a city...">
                <div class="unit-toggle">
                    <button id="celsius-btn" class="active">&deg;C</button>
                    <button id="fahrenheit-btn">&deg;F</button>
                </div>
            </div>
            <div class="current-weather">
                <div class="temp-details">
                    <h1 id="city-name">Loading...</h1>
                    <p id="weather-description">Please allow location access</p>
                    <span id="temperature">--&deg;</span>
                    <p id="feels-like">Feels like: --&deg;</p>
                </div>
                <img id="weather-icon" src="" alt="">
            </div>
            <div class="additional-details">
                <div class="detail-item"><span>Humidity</span><strong id="humidity">--%</strong></div>
                <div class="detail-item"><span>Wind Speed</span><strong id="wind-speed">-- km/h</strong></div>
                <div class="detail-item"><span>Sunrise</span><strong id="sunrise">--:--</strong></div>
                <div class="detail-item"><span>Sunset</span><strong id="sunset">--:--</strong></div>
            </div>
            <div class="forecast-container" id="forecast-container"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // No API key needed here anymore!

            // --- DOM ELEMENTS ---
            const scene = document.getElementById('weather-scene');
            const cityInput = document.getElementById('city-input');
            const celsiusBtn = document.getElementById('celsius-btn');
            const fahrenheitBtn = document.getElementById('fahrenheit-btn');
            const elements = {
                city: document.getElementById('city-name'),
                desc: document.getElementById('weather-description'),
                temp: document.getElementById('temperature'),
                feels: document.getElementById('feels-like'),
                icon: document.getElementById('weather-icon'),
                humidity: document.getElementById('humidity'),
                wind: document.getElementById('wind-speed'),
                sunrise: document.getElementById('sunrise'),
                sunset: document.getElementById('sunset'),
                forecast: document.getElementById('forecast-container')
            };

            // --- STATE MANAGEMENT ---
            let currentUnit = 'metric';
            let lastQuery = { type: 'city', value: 'London' }; // Default city

            // --- WEATHER SCENE/ANIMATION LOGIC ---
            const createWeatherScene = (condition) => {
                scene.innerHTML = ''; // Clear previous scene
                const addClouds = () => {
                    for (let i = 0; i < 15; i++) {
                        const size = 50 + Math.random() * 150;
                        scene.innerHTML += `<div class="cloud layer${Math.ceil(Math.random()*3)}" style="width:${size}px; height:${size*0.6}px; top:${Math.random()*40}%; left:${Math.random()*100}vw; animation-delay: ${Math.random()*-50}s;"></div>`;
                    }
                };
                if (condition === 'Clear') {
                    scene.innerHTML += '<div class="sun"></div>';
                    for (let i = 0; i < 50; i++) scene.innerHTML += `<div class="mote" style="left: ${Math.random()*100}vw; top: ${Math.random()*100}vh; animation-delay: ${Math.random()*20}s;"></div>`;
                } else if (condition === 'Clouds') {
                    addClouds();
                } else if (['Rain', 'Drizzle'].includes(condition)) {
                    addClouds();
                    for (let i = 0; i < 100; i++) scene.innerHTML += `<div class="raindrop" style="left:${Math.random()*100}vw; animation-delay:${Math.random()*2}s; animation-duration:${0.5+Math.random()*0.5}s;"></div>`;
                } else if (condition === 'Snow') {
                    addClouds();
                    for (let i = 0; i < 100; i++) scene.innerHTML += `<div class="snowflake" style="left:${Math.random()*100}vw; animation-delay:${Math.random()*10}s; animation-duration:${5+Math.random()*5}s; opacity:${Math.random()};"></div>`;
                } else if (condition === 'Thunderstorm') {
                    addClouds();
                    scene.innerHTML += '<div class="lightning"></div>';
                    for (let i = 0; i < 100; i++) scene.innerHTML += `<div class="raindrop" style="left:${Math.random()*100}vw; animation-delay:${Math.random()*2}s;"></div>`;
                }
            };

            // --- DATA & UI UPDATE LOGIC ---
            const updateUI = (weather, forecast) => {
                try {
                    const { name, main, weather: [currentWeather], wind, sys, dt } = weather;
                    const isDay = dt > sys.sunrise && dt < sys.sunset;
                    document.body.className = isDay ? 'light-theme' : 'dark-theme';
                    createWeatherScene(currentWeather.main);
                    const tempUnit = currentUnit === 'metric' ? '°C' : '°F';
                    const windUnit = currentUnit === 'metric' ? ' km/h' : ' mph';
                    elements.city.textContent = name;
                    elements.desc.textContent = currentWeather.description;
                    elements.temp.textContent = `${Math.round(main.temp)}${tempUnit}`;
                    elements.feels.textContent = `Feels like: ${Math.round(main.feels_like)}${tempUnit}`;
                    elements.humidity.textContent = `${main.humidity}%`;
                    elements.wind.textContent = `${Math.round(wind.speed)}${windUnit}`;
                    elements.icon.src = `https://openweathermap.org/img/wn/${currentWeather.icon}@4x.png`;
                    const formatTime = (timestamp) => new Date(timestamp * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    elements.sunrise.textContent = formatTime(sys.sunrise);
                    elements.sunset.textContent = formatTime(sys.sunset);
                    elements.forecast.innerHTML = '';
                    const forecastDays = forecast.list.filter(item => item.dt_txt.includes("12:00:00"));
                    forecastDays.forEach(day => {
                        const dayName = new Date(day.dt * 1000).toLocaleDateString('en-US', { weekday: 'short' });
                        elements.forecast.innerHTML += `
                            <div class="forecast-card">
                                <span>${dayName}</span>
                                <img src="https://openweathermap.org/img/wn/${day.weather[0].icon}.png" alt="">
                                <strong>${Math.round(day.main.temp)}${tempUnit}</strong>
                            </div>`;
                    });
                } catch (error) {
                    console.error("Error updating UI:", error);
                    elements.city.textContent = "Error";
                    elements.desc.textContent = "Could not display weather data.";
                }
            };

            // --- FETCH LOGIC (NOW CALLS OUR OWN API) ---
            const fetchAndDisplayWeather = async () => {
                let apiEndpoint;
                if (lastQuery.type === 'city') {
                    apiEndpoint = `/api/getWeather?city=${lastQuery.value}&units=${currentUnit}`;
                } else { // type is 'coords'
                    apiEndpoint = `/api/getWeather?lat=${lastQuery.value.lat}&lon=${lastQuery.value.lon}&units=${currentUnit}`;
                }
                
                try {
                    elements.city.textContent = "Fetching...";
                    elements.desc.textContent = "";
                    const response = await fetch(apiEndpoint);
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Server error');
                    }
                    const { weather, forecast } = await response.json();
                    
                    // Update lastQuery with city name from coords for consistency
                    if (lastQuery.type === 'coords') {
                        lastQuery = { type: 'city', value: weather.name };
                    }

                    updateUI(weather, forecast);
                } catch (error) {
                    elements.city.textContent = "Error";
                    elements.desc.textContent = error.message;
                }
            };

            // --- EVENT LISTENERS ---
            cityInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && cityInput.value) {
                    lastQuery = { type: 'city', value: cityInput.value };
                    fetchAndDisplayWeather();
                }
            });

            celsiusBtn.addEventListener('click', () => {
                if (currentUnit !== 'metric') {
                    currentUnit = 'metric';
                    celsiusBtn.classList.add('active');
                    fahrenheitBtn.classList.remove('active');
                    if (lastQuery) fetchAndDisplayWeather();
                }
            });

            fahrenheitBtn.addEventListener('click', () => {
                if (currentUnit !== 'imperial') {
                    currentUnit = 'imperial';
                    fahrenheitBtn.classList.add('active');
                    celsiusBtn.classList.remove('active');
                    if (lastQuery) fetchAndDisplayWeather();
                }
            });
            
            // --- INITIAL LOAD ---
            const init = () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            lastQuery = { type: 'coords', value: { lat: position.coords.latitude, lon: position.coords.longitude } };
                            fetchAndDisplayWeather();
                        },
                        () => { // Geolocation failed or was denied
                            fetchAndDisplayWeather(); // Fetch default city
                        }
                    );
                } else {
                    fetchAndDisplayWeather(); // Geolocation not supported, fetch default
                }
            };

            init();

        });
    </script>
</body>
</html>
